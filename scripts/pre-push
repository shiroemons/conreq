#!/bin/sh
#
# Pre-push hook for conreq project
# Runs lint, fmt, vet, and test checks before pushing
#

echo "ðŸ” Running pre-push checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Exit on any error
set -e

# 1. Check if code is properly formatted
echo "ðŸ“ Checking code formatting..."
if ! go fmt ./... | grep -q .; then
    echo "${GREEN}âœ“ Code formatting check passed${NC}"
else
    echo "${RED}âœ— Code needs formatting${NC}"
    echo "Run 'go fmt ./...' to fix formatting issues"
    exit 1
fi

# 2. Run go vet
echo "ðŸ” Running go vet..."
if go vet ./... 2>&1; then
    echo "${GREEN}âœ“ go vet passed${NC}"
else
    echo "${RED}âœ— go vet failed${NC}"
    exit 1
fi

# 3. Run golangci-lint via Docker
echo "ðŸ” Running golangci-lint..."
if docker run --rm -v "$PWD":/app -w /app golangci/golangci-lint:v2.3.0 golangci-lint run 2>&1; then
    echo "${GREEN}âœ“ golangci-lint passed${NC}"
else
    echo "${RED}âœ— golangci-lint failed${NC}"
    exit 1
fi

# 4. Run tests
echo "ðŸ§ª Running tests..."
if go test ./... 2>&1; then
    echo "${GREEN}âœ“ All tests passed${NC}"
else
    echo "${RED}âœ— Tests failed${NC}"
    exit 1
fi

echo "${GREEN}âœ… All pre-push checks passed!${NC}"
exit 0